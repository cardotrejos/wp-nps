# API Contracts - FlowPulse

## Overview

FlowPulse uses **oRPC** for type-safe API communication between frontend and backend. The API is served via Elysia on Bun runtime.

## Base Configuration

- **Server URL**: `http://localhost:3000`
- **RPC Endpoint**: `/rpc/*`
- **OpenAPI Endpoint**: `/api/*`
- **Auth Endpoint**: `/api/auth/*`

## Authentication

All protected endpoints require a valid session. Authentication is handled via **Better Auth** with:
- Email/password authentication
- Session-based authentication with secure cookies
- CORS configured for frontend origin

### Auth Flow
1. Client calls `/api/auth/sign-up` or `/api/auth/sign-in`
2. Server returns session cookie (httpOnly, secure, sameSite: none)
3. Subsequent requests include credentials for session validation

## Procedures

### Public Procedures

#### `healthCheck`
```typescript
// Request: None
// Response: "OK"

orpc.healthCheck.queryOptions()
```

**Description**: Simple health check to verify API connectivity.

### Protected Procedures

#### `privateData`
```typescript
// Request: None (session required)
// Response: { message: string, user: User }

orpc.privateData.queryOptions()
```

**Description**: Returns private data for authenticated user. Requires valid session.

**Error**: Returns `UNAUTHORIZED` if no session present.

## Middleware

### `requireAuth`
Applied to all protected procedures. Validates session and throws `ORPCError("UNAUTHORIZED")` if not authenticated.

```typescript
const requireAuth = o.middleware(async ({ context, next }) => {
  if (!context.session?.user) {
    throw new ORPCError("UNAUTHORIZED");
  }
  return next({ context: { session: context.session } });
});
```

## Context

The API context provides:
```typescript
type Context = {
  session: {
    user: User;
    // ... session data
  } | null;
}
```

## Client Usage

### Frontend Setup
```typescript
import { createORPCClient } from "@orpc/client";
import { RPCLink } from "@orpc/client/fetch";

const link = new RPCLink({
  url: `${import.meta.env.VITE_SERVER_URL}/rpc`,
  fetch(url, options) {
    return fetch(url, { ...options, credentials: "include" });
  },
});

export const client = createORPCClient(link);
```

### TanStack Query Integration
```typescript
import { createTanstackQueryUtils } from "@orpc/tanstack-query";
export const orpc = createTanstackQueryUtils(client);

// Usage in component
const healthCheck = useQuery(orpc.healthCheck.queryOptions());
```

## Type Safety

The API is fully type-safe end-to-end:
- `AppRouter` type exported from `@wp-nps/api/routers/index`
- `AppRouterClient` type for client-side usage
- Zod schemas for request/response validation via `@orpc/zod`

---

*Generated by BMAD Document Project Workflow*
